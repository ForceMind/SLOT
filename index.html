<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>3x3 SLOT H5 Demo</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  /* ===== é«˜é¥±å’Œä¸»é¢˜é…è‰²ï¼ˆéœ“è™¹èµ›åšé£ï¼‰ ===== */
  :root{
    --bg1:#0a0014; --bg2:#18002b; --bg3:#2b0040; /* æ·±è‰²èƒŒæ™¯åŸºåº• */
    --panel:#1b0b2a; --border:#4e1b9a;
    --accent:#ff2fd0; --accent2:#13d0ff; --accent3:#ffd319; /* é«˜é¥±å’Œä¸»è‰² */
    --text:#fff7ff; --muted:#cbb6ff;
    --win:#29f19c; --lose:#ff5a5a; --warn:#ffd166;
    --btn1:#3a0ca3; --btn2:#7209b7; --btn3:#f72585; /* æŒ‰é’®æ¸å˜ */
    --cell1:#32104d; --cell2:#3f0f6b; --cellBorder:#7b2cbf; /* æ ¼å­åº•è‰² */
    --glow:0 0 16px rgba(247,37,133,.45), 0 0 28px rgba(19,208,255,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:
      radial-gradient(1200px 700px at 70% -20%, rgba(19,208,255,.25) 0%, rgba(19,208,255,0) 60%),
      radial-gradient(900px 500px at -20% 120%, rgba(247,37,133,.25) 0%, rgba(247,37,133,0) 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2) 40%, var(--bg3));
    color:var(--text);
  }
  .app{max-width:900px;margin:0 auto; padding:16px 16px 28px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .brand{font-weight:900;letter-spacing:.6px;font-size:18px}
  .balance{display:flex;gap:10px;align-items:center;}
  .chip{background:linear-gradient(145deg,#2a0b4b,#140628); border:1px solid var(--border);
        padding:8px 10px; border-radius:14px; box-shadow: var(--glow); display:flex; align-items:center; gap:8px}
  .chip strong{font-variant-numeric:tabular-nums}
  .chip .add{width:28px;height:28px; display:inline-flex; align-items:center; justify-content:center; 
             border-radius:8px; background:linear-gradient(180deg,#ff2fd0,#c112a1); border:1px solid #ff8be6;
             cursor:pointer; font-weight:900; color:#fff; box-shadow:0 0 10px rgba(255,47,208,.5)}

  .board-wrap{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.0)); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: var(--glow);}
  .reels{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; background:linear-gradient(160deg,var(--cell1),var(--cell2)); padding:12px; border-radius:12px; border:1px solid var(--cellBorder);}  
  .col{ display:grid; grid-template-rows:repeat(3,1fr); gap:10px;}
  .cell{ aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:44px; border-radius:14px; background:radial-gradient(circle at 30% 25%, #5a1fb5, #2b0b5e 60%);
         border:1px solid #a064ff; box-shadow: inset 0 0 18px rgba(0,0,0,.45), 0 4px 14px rgba(0,0,0,.45);}
  .cell.spinning{filter:saturate(0.9) brightness(.95); animation: pulse .25s linear infinite alternate;}
  @keyframes pulse{ to{ transform: translateY(-1px);} }

  /* ===== æ§åˆ¶åŒºï¼šä¸‰åˆ—å¸ƒå±€ï¼›ç§»åŠ¨ç«¯å †å å¹¶é¿å…æŒ¤å‹ ===== */
  .controls{display:grid; grid-template-columns:1.2fr 1.2fr 1.6fr; gap:10px; margin-top:14px;}
  .group{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .group label{color:var(--muted); font-size:12px;}
  .input{display:flex; align-items:center; gap:8px; margin-left:auto;}
  .btn{appearance:none; border:none; background:linear-gradient(180deg,var(--btn2),var(--btn3)); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; border:1px solid #a84ae4; font-weight:700; min-width:44px}
  .btn.secondary{background:linear-gradient(180deg,var(--btn1),var(--btn2));}
  .btn.ghost{background:transparent; border:1px dashed #a84ae4}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .grow{flex:1}

  /* ===== æ”¯ä»˜è¡¨æ ·å¼ ===== */
  .status{margin-top:12px; min-height:28px; font-size:14px}
  .status .ok{color:var(--win)}
  .status .bad{color:var(--lose)}
  .status .warn{color:var(--warn)}
  .paytable{margin-top:10px; font-size:13px; border-top:1px dashed #8b3df0; padding-top:10px; color:var(--muted)}
  .pt-grid{display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:6px;}
  .pt-item{background:rgba(255,255,255,.06); border:1px solid var(--border); padding:6px; border-radius:10px; text-align:center}

  /* ===== è®¾ç½®å¼¹çª— ===== */
  .modal-mask{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:10}
  .modal{width:min(560px,92vw); background:linear-gradient(180deg,#2a0b4b,#15062a); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:var(--glow)}
  .modal h3{margin:6px 0 10px; font-size:16px}
  .row{display:flex; align-items:center; gap:10px; margin:8px 0; flex-wrap:wrap}
  .row .spacer{flex:1}
  .field{display:flex; align-items:center; gap:8px}
  .field input[type="number"]{width:110px; padding:8px 10px; border-radius:10px; border:1px solid #a84ae4; background:#11061f; color:#fff}
  .muted{color:var(--muted); font-size:12px}

  /* ===== ç§»åŠ¨ç«¯ï¼ˆâ‰¤640pxï¼‰ï¼šæ§ä»¶å‚ç›´ã€æŒ‰é’®ä¸æ‹¥æŒ¤ ===== */
  @media (max-width:640px){
    .controls{grid-template-columns:1fr}
    .group{flex-direction:column; align-items:stretch}
    .group label{margin-bottom:6px}
    .input{width:100%; margin-left:0; justify-content:space-between}
    .btn{min-width:48px}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">ğŸ° 3Ã—3 SLOT</div>
      <div class="balance chip" id="balanceChip">ä½™é¢ï¼š<strong id="balance">1000</strong>
        <!-- å³ä¸Šè§’åŠ é’±æŒ‰é’®ï¼šæ¯æ¬¡ +100 -->
        <span class="add" id="balanceAdd">+</span>
      </div>
    </header>

    <section class="board-wrap">
      <!-- è½¬è½´åŒºåŸŸï¼š3 åˆ— Ã— 3 è¡Œ -->
      <div class="reels" id="reels">
        <div class="col" data-col="0">
          <div class="cell" id="c00"></div>
          <div class="cell" id="c01"></div>
          <div class="cell" id="c02"></div>
        </div>
        <div class="col" data-col="1">
          <div class="cell" id="c10"></div>
          <div class="cell" id="c11"></div>
          <div class="cell" id="c12"></div>
        </div>
        <div class="col" data-col="2">
          <div class="cell" id="c20"></div>
          <div class="cell" id="c21"></div>
          <div class="cell" id="c22"></div>
        </div>
      </div>

      <!-- æ§åˆ¶åŒºï¼šä¸‹æ³¨/çº¿æ•°/æ—‹è½¬/è®¾ç½® -->
      <div class="controls">
        <div class="group">
          <label>ä¸‹æ³¨ (æ¯çº¿)</label>
          <div class="input">
            <button class="btn secondary" id="betMinus">-</button>
            <strong id="bet">5</strong>
            <button class="btn secondary" id="betPlus">+</button>
          </div>
        </div>

        <div class="group">
          <label>çº¿æ•°</label>
          <div class="input">
            <button class="btn secondary" id="linesMinus">-</button>
            <strong id="lines">5</strong>
            <button class="btn secondary" id="linesPlus">+</button>
          </div>
        </div>

        <div class="group">
          <button class="btn grow" id="spinBtn">SPIN</button>
          <button class="btn" id="autoBtn">AUTO Ã— 25</button>
          <button class="btn ghost" id="settingsBtn">è®¾ç½®</button>
        </div>
      </div>

      <div class="status" id="status"></div>

      <div class="paytable">
        <div>ğŸ¯ æ”¯ä»˜çº¿ï¼ˆæœ€å¤š5æ¡ï¼‰ï¼šæ¨ªæ’3æ¡ + ä¸¤æ¡å¯¹è§’çº¿ã€‚3ä¸ªç›¸åŒå›¾æ ‡è¿çº¿å³ä¸­å¥–ï¼ˆä»…æŒ‰ä»å·¦åˆ°å³ç»“ç®—ï¼‰ã€‚</div>
        <div class="pt-grid" id="ptGrid"></div>
      </div>

      <div class="footer muted">æç¤ºï¼šçº¿æ•°ä¸èƒ½è¶…è¿‡è®¾ç½®ä¸­çš„â€œå¯ç”¨ä¸­å¥–çº¿æ•°â€ã€‚</div>
    </section>
  </div>

  <!-- ===== è®¾ç½®å¼¹çª—ï¼ˆåŒ…å«ä¸­å¥–çº¿ä¸Šé™ & æ¨¡æ‹Ÿå™¨ï¼‰ ===== -->
  <div class="modal-mask" id="modalMask">
    <div class="modal">
      <div class="row">
        <h3>âš™ï¸ è®¾ç½®</h3>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeModal">å…³é—­</button>
      </div>

      <div class="row">
        <label>å¯ç”¨ä¸­å¥–çº¿æ•°ï¼ˆ1â€“5ï¼‰</label>
        <div class="field">
          <button class="btn secondary" id="maxLinesMinus">-</button>
          <strong id="maxLinesLabel">5</strong>
          <button class="btn secondary" id="maxLinesPlus">+</button>
        </div>
      </div>
      <div class="muted">è¯´æ˜ï¼šä¸‹æ³¨çš„â€œçº¿æ•°â€ä¸å¾—è¶…è¿‡æ­¤å¤„è®¾ç½®çš„å¯ç”¨ä¸­å¥–çº¿æ•°ã€‚</div>

      <hr style="border:none;border-top:1px dashed #8b3df0; margin:12px 0"/>
      <h3>ğŸ§ª æ¨¡æ‹Ÿä¸‹æ³¨ï¼ˆä¼°ç®—è¿”å¥–ç‡ï¼‰</h3>
      <div class="row">
        <label>æ¯çº¿ä¸‹æ³¨</label>
        <div class="field"><input id="simBet" type="number" value="5" min="1" max="100" /></div>
        <label>çº¿æ•°</label>
        <div class="field"><input id="simLines" type="number" value="5" min="1" max="5" /></div>
        <label>æ¬¡æ•°</label>
        <div class="field"><input id="simRounds" type="number" value="1000" min="1" max="100000" /></div>
        <button class="btn" id="runSim">å¼€å§‹æ¨¡æ‹Ÿ</button>
      </div>
      <div class="muted">è¿”å¥–ç‡ï¼ˆRTPï¼‰= æ€»è·å¾— / æ€»ä¸‹æ³¨ Ã— 100%</div>
      <div id="simResult" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

<script>
(function(){
  /* =================== åŸºç¡€æ•°æ® & çŠ¶æ€ =================== */
  // ç¬¦å·ä¸èµ”ç‡ï¼ˆ3è¿åŒå›¾çš„å€æ•°ï¼‰ã€‚weight ä¸ºæƒé‡ï¼ˆå‡ºç°æ¦‚ç‡ï¼‰ã€‚
  const SYMBOLS = [
    { id:'CHERRY', icon:'ğŸ’', weight:28, pay:10 },
    { id:'BELL',   icon:'ğŸ””', weight:24, pay:15 },
    { id:'STAR',   icon:'â­', weight:20, pay:20 },
    { id:'DIAM',   icon:'ğŸ’', weight:16, pay:30 },
    { id:'SEVEN',  icon:'7ï¸âƒ£', weight:12, pay:50 },
  ];
  // 5 æ¡æ”¯ä»˜çº¿ï¼š3 æ¨ª + 2 æ–œï¼ˆä»å·¦åˆ°å³ï¼‰ã€‚
  const LINES = [
    [[0,0],[1,0],[2,0]], // é¡¶è¡Œ
    [[0,1],[1,1],[2,1]], // ä¸­è¡Œ
    [[0,2],[1,2],[2,2]], // åº•è¡Œ
    [[0,0],[1,1],[2,2]], // ä¸»å¯¹è§’
    [[0,2],[1,1],[2,0]], // å‰¯å¯¹è§’
  ];

  // å…¨å±€çŠ¶æ€
  const state = {
    balance: 1000,        // ä½™é¢
    betPerLine: 5,        // æ¯çº¿ä¸‹æ³¨
    lines: 5,             // å½“å‰ä¸‹æ³¨çº¿æ•°
    maxLines: 5,          // å¯ç”¨ä¸­å¥–çº¿æ•°ï¼ˆè®¾ç½®ä¸­å¯è°ƒï¼‰
    spinning: false,      // æ˜¯å¦æ­£åœ¨æ—‹è½¬
    autoLeft: 0,          // è‡ªåŠ¨æ—‹è½¬å‰©ä½™æ¬¡æ•°
    autoTimer: null,      // è‡ªåŠ¨æ—‹è½¬çš„è®¡æ—¶å™¨å¥æŸ„
  };

  /* =================== DOM å¼•ç”¨ =================== */
  const $ = sel => document.querySelector(sel);
  const balanceEl = $('#balance');
  const betEl = $('#bet');
  const linesEl = $('#lines');
  const statusEl = $('#status');
  const spinBtn = $('#spinBtn');
  const autoBtn = $('#autoBtn');
  const settingsBtn = $('#settingsBtn');
  const balanceAdd = $('#balanceAdd');
  const betMinus = $('#betMinus');
  const betPlus = $('#betPlus');
  const linesMinus = $('#linesMinus');
  const linesPlus = $('#linesPlus');
  const ptGrid = $('#ptGrid');

  const modalMask = $('#modalMask');
  const closeModal = $('#closeModal');
  const maxLinesMinus = $('#maxLinesMinus');
  const maxLinesPlus = $('#maxLinesPlus');
  const maxLinesLabel = $('#maxLinesLabel');
  const simBet = $('#simBet');
  const simLines = $('#simLines');
  const simRounds = $('#simRounds');
  const runSim = $('#runSim');
  const simResult = $('#simResult');

  // æ”¯ä»˜è¡¨æ¸²æŸ“
  ptGrid.innerHTML = '';
  SYMBOLS.forEach(s=>{
    const div = document.createElement('div');
    div.className='pt-item';
    div.textContent = `${s.icon} Ã—3 = å€ç‡ ${s.pay}Ã—`;
    ptGrid.appendChild(div);
  });

  /* =================== å·¥å…·å‡½æ•° =================== */
  function updateHUD(){
    balanceEl.textContent = state.balance.toFixed(0);
    betEl.textContent = state.betPerLine.toFixed(0);
    linesEl.textContent = state.lines;

    // è‡ªåŠ¨æŒ‰é’®çŠ¶æ€æ–‡æ¡ˆ
    if(state.autoLeft>0){
      autoBtn.textContent = `åœæ­¢è‡ªåŠ¨ï¼ˆå‰© ${state.autoLeft}ï¼‰`;
    } else {
      autoBtn.textContent = 'AUTO Ã— 25';
    }

    // è®¾ç½®ä¸­çš„å¯ç”¨çº¿æ•°
    maxLinesLabel.textContent = state.maxLines;
  }
  function setStatus(msg, cls=''){
    statusEl.className='status';
    if(cls) statusEl.classList.add(cls);
    statusEl.textContent = msg;
  }
  function totalBet(){ return state.betPerLine * state.lines; }
  function canSpin(){
    // çº¿æ•°æ£€æŸ¥
    if(state.lines > state.maxLines) return false;
    const tb = totalBet();
    return !state.spinning && tb>0 && state.balance >= tb;
  }

  // åŠ æƒéšæœºå–ä¸€ä¸ªç¬¦å·
  function pickSymbol(){
    const totalW = SYMBOLS.reduce((a,s)=>a+s.weight,0);
    let t = Math.random()*totalW;
    for(const s of SYMBOLS){ if((t -= s.weight) <= 0) return s; }
    return SYMBOLS[0];
  }
  // ç”Ÿæˆä¸€æ¬¡ 3Ã—3 ç»“æœç½‘æ ¼ grid[col][row]
  function spinOnce(){
    return Array.from({length:3},()=>Array.from({length:3},()=>pickSymbol()));
  }
  // è®¡ç®—ä¸­å¥–ï¼šä»…ç»Ÿè®¡æ¿€æ´»çº¿ä¸­çš„ 3 è¿ç›¸åŒ
  function evaluate(grid){
    const activeLines = LINES.slice(0, state.lines);
    let win = 0; const hits = [];
    for(let i=0;i<activeLines.length;i++){
      const coords = activeLines[i];
      const a = grid[coords[0][0]][coords[0][1]];
      const b = grid[coords[1][0]][coords[1][1]];
      const c = grid[coords[2][0]][coords[2][1]];
      if(a.id===b.id && b.id===c.id){
        const linePay = state.betPerLine * a.pay;
        win += linePay;
        hits.push({line:i, symbol:a});
      }
    }
    return {win, hits};
  }
  // å°†ç½‘æ ¼å±•ç¤ºåˆ° UI
  function renderGrid(grid){
    for(let x=0;x<3;x++){
      for(let y=0;y<3;y++){
        const el = document.getElementById(`c${x}${y}`);
        el.textContent = grid[x][y].icon;
      }
    }
  }

  /* =================== æ—‹è½¬æµç¨‹ =================== */
  async function doSpin(){
    if(!canSpin()){
      if(state.spinning) return; // æ­£åœ¨æ—‹è½¬å°±ä¸å†è§¦å‘
      if(state.lines > state.maxLines){
        setStatus(`çº¿æ•° (${state.lines}) è¶…å‡ºå¯ç”¨ä¸­å¥–çº¿æ•° (${state.maxLines})ï¼Œè¯·åœ¨è®¾ç½®ä¸­è°ƒæ•´ã€‚`, 'warn');
        return;
      }
      const need = totalBet() - state.balance;
      setStatus(need>0 ? `ä½™é¢ä¸è¶³ï¼Œå·® ${need.toFixed(0)}ã€‚` : `æ— æ•ˆçš„ä¸‹æ³¨ã€‚`, 'warn');
      return;
    }
    state.spinning = true;
    setControlsEnabled(false);

    const tb = totalBet();
    state.balance -= tb; updateHUD(); setStatus(`ä¸‹æ³¨ ${tb}ï¼Œæ—‹è½¬ä¸­â€¦`);

    // å¼€å§‹åˆ—æ»šåŠ¨åŠ¨ç”»
    const timers = [];
    [0,1,2].forEach((cx)=>{
      const cells = [0,1,2].map(r=>document.getElementById(`c${cx}${r}`));
      cells.forEach(el=>el.classList.add('spinning'));
      timers[cx] = setInterval(()=>{ cells.forEach(el=>{ el.textContent = pickSymbol().icon; }); }, 55);
    });

    // ç›®æ ‡ç»“æœ
    const grid = spinOnce();
    // ä¾æ¬¡åœè½®
    for(let stopCol=0; stopCol<3; stopCol++){
      await new Promise(res=>setTimeout(res, 320 + stopCol*230));
      clearInterval(timers[stopCol]);
      [0,1,2].forEach(r=>{
        const el = document.getElementById(`c${stopCol}${r}`);
        el.textContent = grid[stopCol][r].icon;
        el.classList.remove('spinning');
      });
    }

    // ç»“ç®—
    const {win, hits} = evaluate(grid);
    if(win>0){
      state.balance += win;
      setStatus(`ğŸ‰ ä¸­å¥– ${win}ï¼`, 'ok');
      // é«˜äº®ä¸­å¥–çº¿
      hits.forEach(h=>{
        const coords = LINES[h.line];
        coords.forEach(([x,y])=>{
          const el = document.getElementById(`c${x}${y}`);
          el.animate([
            {boxShadow:'0 0 0 rgba(41,241,156,0)'},
            {boxShadow:'0 0 22px rgba(41,241,156,.95)'},
            {boxShadow:'0 0 0 rgba(41,241,156,0)'}
          ],{duration:720, easing:'ease-out'});
        });
      });
    } else {
      setStatus('æœªä¸­å¥–ï¼Œå†è¯•ä¸€æ¬¡ï¼');
    }
    updateHUD();

    state.spinning = false;
    setControlsEnabled(true);

    // è‡ªåŠ¨æ¨¡å¼ï¼šå¦‚æœè¿˜æœ‰æ¬¡æ•°ï¼Œç»§ç»­ï¼›å¦åˆ™æ¢å¤æŒ‰é’®
    if(state.autoLeft>0){
      state.autoLeft--; updateHUD();
      if(state.autoLeft>0){
        // å°é—´éš”ç»­è½¬ï¼ˆä¿å­˜å¥æŸ„ï¼Œä¾¿äºâ€œåœæ­¢è‡ªåŠ¨â€ï¼‰
        state.autoTimer = setTimeout(doSpin, 420);
      } else {
        // è‡ªåŠ¨ç»“æŸ
        updateHUD();
      }
    }
  }

  /* =================== äº¤äº’äº‹ä»¶ =================== */
  function setControlsEnabled(enabled){
    // æ ¹æ® enabled ç»Ÿä¸€å¼€å…³é™¤â€œåœæ­¢è‡ªåŠ¨â€ä»¥å¤–çš„æ§ä»¶
    spinBtn.disabled = !enabled;
    settingsBtn.disabled = !enabled;
    betMinus.disabled = betPlus.disabled = linesMinus.disabled = linesPlus.disabled = !enabled;
  }

  spinBtn.addEventListener('click', doSpin);

  // è‡ªåŠ¨æŒ‰é’®ï¼šç©ºé—²æ—¶å¯åŠ¨ 25 æ¬¡ï¼›è¿è¡Œæ—¶åˆ™â€œåœæ­¢è‡ªåŠ¨â€
  autoBtn.addEventListener('click', ()=>{
    if(state.spinning) return;
    if(state.autoLeft>0){
      // åœæ­¢è‡ªåŠ¨
      state.autoLeft = 0; updateHUD();
      if(state.autoTimer){ clearTimeout(state.autoTimer); state.autoTimer = null; }
      setStatus('å·²åœæ­¢è‡ªåŠ¨ã€‚', 'warn');
      return;
    }
    // å¯åŠ¨è‡ªåŠ¨
    state.autoLeft = 25; updateHUD(); doSpin();
  });

  // å³ä¸Šè§’ +100 æŒ‰é’®
  balanceAdd.addEventListener('click', ()=>{ state.balance += 100; updateHUD(); setStatus('å·²æ·»åŠ è¯•ç”¨é‡‘ 100ã€‚', 'ok'); });

  // ä¸‹æ³¨é¢åº¦ä¸çº¿æ•°ï¼ˆçº¿æ•°ä¸Šé™å— maxLines é™åˆ¶ï¼‰
  betMinus.addEventListener('click', ()=>{ if(state.betPerLine>1){ state.betPerLine--; updateHUD(); }});
  betPlus.addEventListener('click', ()=>{ state.betPerLine = Math.min(100, state.betPerLine+1); updateHUD(); });
  linesMinus.addEventListener('click', ()=>{ state.lines = Math.max(1, state.lines-1); updateHUD(); });
  linesPlus.addEventListener('click', ()=>{ state.lines = Math.min(state.maxLines, state.lines+1); updateHUD(); });

  // ===== è®¾ç½®å¼¹çª—å¼€å…³ =====
  settingsBtn.addEventListener('click', ()=>{ modalMask.style.display='flex'; });
  closeModal.addEventListener('click', ()=>{ modalMask.style.display='none'; });
  modalMask.addEventListener('click', (e)=>{ if(e.target===modalMask) modalMask.style.display='none'; });

  // è°ƒæ•´å¯ç”¨ä¸­å¥–çº¿æ•°
  document.getElementById('maxLinesMinus').addEventListener('click', ()=>{
    state.maxLines = Math.max(1, state.maxLines-1);
    if(state.lines>state.maxLines) state.lines = state.maxLines; // å›è½è‡³ä¸Šé™
    updateHUD();
  });
  document.getElementById('maxLinesPlus').addEventListener('click', ()=>{
    state.maxLines = Math.min(5, state.maxLines+1);
    updateHUD();
  });

  // ===== æ¨¡æ‹Ÿå™¨ï¼šæ‰¹é‡è¿è¡Œå¹¶ç»™å‡ºè¿”å¥–ç‡ï¼ˆRTPï¼‰ =====
  runSim.addEventListener('click', ()=>{
    const bet = Math.max(1, Math.min(100, Number(simBet.value)||1));
    const lines = Math.max(1, Math.min(5, Number(simLines.value)||1));
    const rounds = Math.max(1, Math.min(100000, Number(simRounds.value)||1));

    const effLines = Math.min(lines, state.maxLines); // éµå®ˆå¯ç”¨çº¿æ•°ä¸Šé™

    let totalStake = 0; // æ€»ä¸‹æ³¨
    let totalGain = 0;  // æ€»è·å¾—
    for(let i=0;i<rounds;i++){
      const grid = Array.from({length:3},()=>Array.from({length:3},()=>pickSymbol()));
      totalStake += bet * effLines;
      // å•æ¬¡ç»“ç®—
      const activeLines = LINES.slice(0, effLines);
      let w = 0;
      for(const coords of activeLines){
        const a = grid[coords[0][0]][coords[0][1]];
        const b = grid[coords[1][0]][coords[1][1]];
        const c = grid[coords[2][0]][coords[2][1]];
        if(a.id===b.id && b.id===c.id){ w += bet * a.pay; }
      }
      totalGain += w;
    }
    const rtp = totalStake>0 ? (totalGain/totalStake*100) : 0; // è¿”å¥–ç‡
    simResult.innerHTML = `
      è¿è¡Œï¼š${rounds.toLocaleString()} æ¬¡ï¼› æ¯çº¿ä¸‹æ³¨ï¼š${bet}ï¼› çº¿æ•°ï¼š${effLines}<br/>
      æ€»ä¸‹æ³¨ï¼š${totalStake.toLocaleString()}ï¼› æ€»è·å¾—ï¼š${totalGain.toLocaleString()}<br/>
      è¿”å¥–ç‡ï¼ˆæ€»å¾—/æ€»æ³¨ï¼‰ï¼š<b>${rtp.toFixed(2)}%</b>
    `;
  });

  /* =================== åˆå§‹åŒ– =================== */
  // åˆå§‹éšæœºå¡«å……ç½‘æ ¼
  const initGrid = Array.from({length:3},()=>Array.from({length:3},()=>pickSymbol()));
  (function renderInit(){
    for(let x=0;x<3;x++) for(let y=0;y<3;y++){
      const el = document.getElementById(`c${x}${y}`);
      el.textContent = initGrid[x][y].icon;
    }
  })();
  updateHUD();
  setStatus('è®¾ç½®ä¸‹æ³¨åç‚¹å‡» SPINã€‚');
})();
</script>
</body>
</html>
